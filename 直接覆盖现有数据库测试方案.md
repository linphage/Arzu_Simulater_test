# 使用现有 PostgreSQL 数据库测试迁移方案

## 前提
- ✅ 本地已有 PostgreSQL 数据库连接
- ✅ 已有 Render 数据库备份文件
- ✅ 想直接在现有数据库上测试

---

## 方案：直接覆盖现有数据库

### 步骤 1：备份本地数据库（安全起见）

```bash
# 1. 先确认你的本地数据库名称（假设是 arzu_local）
# 查看所有数据库
"C:\Program Files\PostgreSQL\17\bin\psql.exe" -U postgres -c "\l"

# 2. 备份本地数据库（可选，万一需要恢复）
"C:\Program Files\PostgreSQL\17\bin\pg_dump.exe" -U postgres arzu_local > backup_local_$(date +%Y%m%d).sql
```

### 步骤 2：清空现有数据库并导入 Render 备份

#### 选项 A：完全替换数据库（推荐）

```bash
# 假设你的本地数据库名是 arzu_local，Render备份文件是 render_backup.sql

# 1. 连接到 postgres 默认数据库
"C:\Program Files\PostgreSQL\17\bin\psql.exe" -U postgres

# 2. 断开所有连接并删除重建数据库
DROP DATABASE IF EXISTS arzu_local;
CREATE DATABASE arzu_local;
\q

# 3. 导入 Render 备份到本地数据库
"C:\Program Files\PostgreSQL\17\bin\psql.exe" -U postgres -d arzu_local -f render_backup.sql
```

#### 选项 B：保留数据库，只清空表（如果选项A报错）

```bash
"C:\Program Files\PostgreSQL\17\bin\psql.exe" -U postgres -d arzu_local

-- 在 psql 中执行：
-- 1. 禁用外键约束
SET session_replication_role = 'replica';

-- 2. 删除所有表（会自动删除索引、约束等）
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;

-- 3. 恢复外键约束
SET session_replication_role = 'origin';

\q

# 4. 导入 Render 备份
"C:\Program Files\PostgreSQL\17\bin\psql.exe" -U postgres -d arzu_local -f render_backup.sql
```

### 步骤 3：执行迁移脚本

```bash
cd C:\Users\Amber\Desktop\Arzu_Simulater_test_backup\Arzu_simulator_back

# 执行 PostgreSQL 迁移脚本
"C:\Program Files\PostgreSQL\17\bin\psql.exe" -U postgres -d arzu_local -f src\database\migrations\012-add-repeat-task-support-postgres.sql
```

### 步骤 4：验证迁移结果

```bash
"C:\Program Files\PostgreSQL\17\bin\psql.exe" -U postgres -d arzu_local

-- 验证 tasks 表结构
\d tasks

-- 应该能看到：
-- parent_task_id | integer           |           |          | 
-- repeat_days     | text              |           |          |

-- 检查现有任务数量
SELECT COUNT(*) as total_tasks FROM tasks;

-- 检查是否有重复任务数据
SELECT id, title, repeat_days, parent_task_id FROM tasks WHERE repeat_days IS NOT NULL LIMIT 5;

\q
```

### 步骤 5：确认环境变量配置

检查你的 `.env` 或 `.env.local` 文件，确保 `DATABASE_URL` 指向本地数据库：

```env
# .env.local（或修改现有的 .env）
DATABASE_URL=postgresql://postgres:你的密码@localhost:5432/arzu_local

# 其他配置...
NODE_ENV=development
PORT=3001
JWT_SECRET=your_local_secret
```

### 步骤 6：启动后端测试

```bash
cd C:\Users\Amber\Desktop\Arzu_Simulater_test_backup\Arzu_simulator_back

# 重新编译
npm run build

# 启动（确保使用本地配置）
npm start
```

检查启动日志应该看到：
```
PostgreSQL连接成功
定时任务已启动：
  - 每月1日凌晨0:00（东八区）：重置补打卡次数
  - 每周一凌晨0:00（东八区）：生成下一周重复任务
```

---

## 常见问题

### Q1：忘记本地数据库名称？
```bash
"C:\Program Files\PostgreSQL\17\bin\psql.exe" -U postgres -c "\l"
# 查看所有数据库列表
```

### Q2：删除数据库时提示"其他用户正在使用"？
```bash
# 强制断开所有连接
"C:\Program Files\PostgreSQL\17\bin\psql.exe" -U postgres

SELECT pg_terminate_backend(pid) 
FROM pg_stat_activity 
WHERE datname = 'arzu_local' AND pid <> pg_backend_pid();

DROP DATABASE arzu_local;
```

### Q3：导入备份文件时报错？
```bash
# 检查备份文件格式
head -20 render_backup.sql

# 如果是压缩文件
gunzip render_backup.sql.gz

# 如果包含 CREATE DATABASE 语句，可以直接导入到 postgres
"C:\Program Files\PostgreSQL\17\bin\psql.exe" -U postgres -f render_backup.sql
```

### Q4：迁移脚本报错 "column already exists"？

说明字段已经存在，有两种处理方式：

**方式1：修改迁移脚本（推荐）**
编辑 `012-add-repeat-task-support-postgres.sql`，在每个 ALTER TABLE 前加上检查：

```sql
-- 检查字段是否存在，不存在才添加
DO $$ 
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name='tasks' AND column_name='parent_task_id'
    ) THEN
        ALTER TABLE tasks ADD COLUMN parent_task_id INTEGER REFERENCES tasks(id) ON DELETE CASCADE;
    END IF;
END $$;
```

**方式2：手动跳过已存在的语句**

---

## 快速命令汇总（复制即用）

```bash
# 1. 查看本地数据库
"C:\Program Files\PostgreSQL\17\bin\psql.exe" -U postgres -c "\l"

# 2. 重建数据库（假设本地库名是 arzu_local）
"C:\Program Files\PostgreSQL\17\bin\psql.exe" -U postgres -c "DROP DATABASE IF EXISTS arzu_local; CREATE DATABASE arzu_local;"

# 3. 导入 Render 备份（替换 backup.sql 为你的文件名）
"C:\Program Files\PostgreSQL\17\bin\psql.exe" -U postgres -d arzu_local -f backup.sql

# 4. 执行迁移
cd C:\Users\Amber\Desktop\Arzu_Simulater_test_backup\Arzu_simulator_back
"C:\Program Files\PostgreSQL\17\bin\psql.exe" -U postgres -d arzu_local -f src\database\migrations\012-add-repeat-task-support-postgres.sql

# 5. 验证
"C:\Program Files\PostgreSQL\17\bin\psql.exe" -U postgres -d arzu_local -c "\d tasks"

# 6. 启动后端
npm run build
npm start
```

---

## 优势对比

| 方案 | 优点 | 缺点 |
|------|------|------|
| **创建新数据库** | 不影响现有数据 | 需要修改环境变量 |
| **覆盖现有数据库** ✅ | 无需修改配置，直接测试 | 会丢失本地数据 |

由于你已经备份了 Render 数据，**直接覆盖现有数据库**更方便！

---

## 测试完成后恢复

如果测试完想恢复本地数据：
```bash
# 恢复之前的本地备份
"C:\Program Files\PostgreSQL\17\bin\psql.exe" -U postgres -d arzu_local -f backup_local_20250110.sql
```

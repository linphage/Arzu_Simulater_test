# 前端奖励卡修改指南

## 需要修改的文件：`Arzu_simulator_front/src/App.tsx`

### 1. 修改 RewardCard 接口定义（约第54-61行）

**原来的代码：**
```typescript
interface RewardCard {
  id: string;
  title: string;
  content: string;
  obtainedAt: Date;
  triggerTime: number; // 触发奖励时的累计专注时长（毫秒）
  isViewed?: boolean; // 是否已查看，用于排序
}
```

**修改为：**
```typescript
interface RewardCard {
  id: number;
  title: string;
  description: string;
  obtainedAt: Date;
  triggerTime: number; // 触发奖励时的累计专注时长（分钟）
  isViewed: boolean; // 是否已查看，用于排序
}
```

### 2. 在文件顶部添加导入（约第1-20行）

**添加：**
```typescript
import { rewardService } from './services/rewardService';
```

### 3. 添加 useEffect 加载奖励卡（约第84行后）

**添加：**
```typescript
// 从后端加载奖励卡
useEffect(() => {
  if (isLoggedIn) {
    const loadRewards = async () => {
      try {
        const rewards = await rewardService.getUserRewards();
        const mappedRewards: RewardCard[] = rewards.map(r => ({
          id: r.id,
          title: r.title,
          description: r.description,
          obtainedAt: new Date(r.obtained_at),
          triggerTime: r.trigger_time_minutes,
          isViewed: r.is_viewed === true || r.is_viewed === 1
        }));
        setRewardCards(mappedRewards);
      } catch (error) {
        console.error('加载奖励卡失败:', error);
      }
    };
    loadRewards();
  }
}, [isLoggedIn]);
```

### 4. 修改 checkRewardTrigger 函数（约第130-162行）

**替换整个函数为：**
```typescript
const checkRewardTrigger = async (newTotalTime: number) => {
  const timeSinceLastReward = newTotalTime - lastRewardTriggerTime;
  const isTestMode = false;
  const testModeDivider = isTestMode ? 10 : 1;
  
  const nextRewardTime = generateRandomRewardTriggerTime() / testModeDivider;
  
  console.log(`🎁 [奖励检查] 当前累计时间: ${Math.round(newTotalTime / 60000)}分钟`);
  console.log(`🎁 [奖励检查] 距上次奖励时间: ${Math.round(timeSinceLastReward / 60000)}分钟`);
  console.log(`🎁 [奖励检查] 需要累计时间: ${Math.round(nextRewardTime / 60000)}分钟`);
  
  if (timeSinceLastReward >= nextRewardTime) {
    try {
      const triggerTimeMinutes = Math.round(newTotalTime / 60000);
      const reward = await rewardService.triggerReward(triggerTimeMinutes);
      
      const newRewardCard: RewardCard = {
        id: reward.id,
        title: reward.title,
        description: reward.description,
        obtainedAt: new Date(reward.obtained_at),
        triggerTime: reward.trigger_time_minutes,
        isViewed: false
      };
      
      setRewardCards(prev => [newRewardCard, ...prev]);
      setLastRewardTriggerTime(newTotalTime);
      
      console.log(`🎉 [奖励触发] 获得奖励卡: ${newRewardCard.title}`);
      
      setTimeout(() => {
        alert(`🎉 恭喜获得奖励卡！\n\n${newRewardCard.title}\n${newRewardCard.description}`);
      }, 500);
    } catch (error) {
      console.error('触发奖励失败:', error);
    }
  }
};
```

### 5. 删除旧的 generateRewardCard 函数（约第109-129行）

**完全删除这个函数，不再需要前端生成奖励文案**

### 6. 修改 handleManualReward 函数（约第164-170行）

**替换为：**
```typescript
const handleManualReward = async () => {
  try {
    const triggerTimeMinutes = Math.round(totalFocusTime / 60000);
    const reward = await rewardService.triggerReward(triggerTimeMinutes);
    
    const newRewardCard: RewardCard = {
      id: reward.id,
      title: reward.title,
      description: reward.description,
      obtainedAt: new Date(reward.obtained_at),
      triggerTime: reward.trigger_time_minutes,
      isViewed: false
    };
    
    setRewardCards(prev => [newRewardCard, ...prev]);
    console.log(`🧪 [手动奖励] 生成测试奖励卡: ${newRewardCard.title}`);
    alert(`🧪 测试奖励卡已生成！\n\n${newRewardCard.title}\n${newRewardCard.description}`);
  } catch (error) {
    console.error('手动触发奖励失败:', error);
    alert('触发奖励失败，请检查后端服务');
  }
};
```

### 7. 修改 handleDeleteRewardCard 函数（约第172-177行）

**替换为：**
```typescript
const handleDeleteRewardCard = async (cardId: number) => {
  if (window.confirm('确定要删除这张奖励卡吗？')) {
    try {
      await rewardService.deleteReward(cardId);
      setRewardCards(prev => prev.filter(card => card.id !== cardId));
      console.log(`🗑️ [奖励卡] 删除奖励卡: ${cardId}`);
    } catch (error) {
      console.error('删除奖励卡失败:', error);
      alert('删除失败，请重试');
    }
  }
};
```

### 8. 修改 handleRewardClick 函数（约第195-209行）

**替换为：**
```typescript
const handleRewardClick = async (rewardCard: RewardCard) => {
  if (!rewardCard.isViewed) {
    try {
      await rewardService.markAsViewed(rewardCard.id);
      setRewardCards(prev => prev.map(card => 
        card.id === rewardCard.id 
          ? { ...card, isViewed: true }
          : card
      ));
      console.log(`👁️ [奖励查看] 奖励卡 "${rewardCard.title}" 已标记为已查看`);
    } catch (error) {
      console.error('标记奖励失败:', error);
    }
  }
  
  setSelectedReward({ ...rewardCard, isViewed: true });
  setCurrentView('reward');
};
```

### 9. 修改所有使用 rewardCard.content 的地方

在整个文件中搜索 `rewardCard.content`，全部替换为 `rewardCard.description`

## 需要修改的文件：`Arzu_simulator_front/src/components/RewardCard.tsx`

### 修改 content 为 description（第8行和第113行）

**第8行：**
```typescript
description: string;  // 改为 description
```

**所有使用的地方也改为 description**

## 需要修改的文件：`Arzu_simulator_front/src/components/RewardView.tsx`

### 修改 content 为 description

1. 接口定义（第9行）改为 `description: string;`
2. 第129行的 `{rewardCard.content}` 改为 `{rewardCard.description}`
3. 如果 description 包含 `\n`，需要处理换行：

```typescript
<div className="text-[14px] font-['ABeeZee:Regular','Noto_Sans_SC:Regular','Noto_Sans_JP:Regular',sans-serif] text-[#3a3f47] leading-relaxed">
  {rewardCard.description.split('\\n').map((line, index) => (
    <p key={index} className="mb-2">{line}</p>
  ))}
</div>
```

## 完成后测试

1. 重启后端服务
2. 刷新前端
3. 测试手动触发奖励
4. 完成专注任务测试自动触发奖励
5. 测试查看和删除奖励卡

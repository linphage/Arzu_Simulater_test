# 🚀 Arzu Simulator 启动前必读 - 会话清理说明

## ❗ 问题症状

如果遇到以下错误：
```
POST /api/v1/tasks/pomodoro/29/periods/start
status: 400
error: "当前会话已有活跃的细分时间段，请先结束当前时间段"
```

或者前端无法开始新的番茄钟细分时间段，说明数据库中存在**未清理的活跃会话**。

---

## ✅ 解决方案（已自动化）

### 方案1：使用npm启动脚本（推荐）✨

系统已配置自动清理，每次启动时自动执行：

```bash
# 后端启动（开发模式）
cd Arzu_simulator_back
npm run dev
# ✅ 会自动执行 predev 钩子，清理活跃会话

# 后端启动（生产模式）
npm start
# ✅ 会自动执行 prestart 钩子，清理活跃会话
```

### 方案2：手动清理脚本

如果需要单独清理，不启动服务器：

#### Windows用户：
```bash
# 方式1：双击批处理文件
Arzu_simulator_back\清理会话.bat

# 方式2：命令行执行
cd Arzu_simulator_back
npm run cleanup
```

#### Linux/Mac用户：
```bash
cd Arzu_simulator_back
npm run cleanup
```

### 方案3：使用原始Node.js脚本

```bash
cd Arzu_simulator_back
node scripts/cleanup-active-sessions.js
```

---

## 🔍 清理脚本功能说明

清理脚本会执行以下操作：

### 步骤1：清理未结束的细分时间段（focus_periods）
- 查找所有 `end_time IS NULL` 的记录
- 自动计算实际时长（从 start_time 到当前时间）
- 设置 `end_time = 当前时间`
- 设置 `is_interrupted = 1`（标记为中断）
- 更新 `duration_min` 字段

### 步骤2：清理未结束的番茄钟会话（pomodoro_sessions）
- 查找所有 `completed_at IS NULL` 的记录
- 计算该会话所有 focus_periods 的总时长
- 设置 `completed_at = 当前时间`
- 设置 `completed = 0`（未完成）
- 更新 `duration_minutes` 为实际累计时长

---

## 📊 清理示例输出

```
🔧 [清理脚本] 开始清理活跃会话和细分时间段...
📁 [清理脚本] 数据库路径: C:\Users\...\database_new_2025-09-25T08-54-04-778Z.db

✅ [清理脚本] 数据库连接成功

🔍 [清理脚本] 步骤1: 查找未结束的细分时间段...
📊 [清理脚本] 找到 3 个未结束的细分时间段
✅ [清理脚本] Period 45 (Session 29) 已清理 - 时长: 12.5 分钟
✅ [清理脚本] Period 46 (Session 29) 已清理 - 时长: 8.3 分钟
✅ [清理脚本] Period 47 (Session 30) 已清理 - 时长: 15.0 分钟
✅ [清理脚本] 步骤1完成: 已清理 3 个细分时间段

🔍 [清理脚本] 步骤2: 查找未结束的番茄钟会话...
📊 [清理脚本] 找到 2 个未结束的会话
✅ [清理脚本] Session 29 (Task 15) 已清理 - 实际时长: 20.8 分钟
✅ [清理脚本] Session 30 (Task 16) 已清理 - 实际时长: 15.0 分钟
✅ [清理脚本] 步骤2完成: 已清理 2 个会话

🎉 [清理脚本] 所有清理任务完成！
✅ [清理脚本] 数据库状态已恢复正常
```

---

## 🤔 为什么需要清理？

### 问题产生原因

1. **异常关闭**：直接关闭浏览器或后端服务器，导致：
   - 未调用 `beforeunload` 事件处理
   - 细分时间段（focus_period）没有正常结束
   - 番茄钟会话（pomodoro_session）没有正常结束

2. **数据残留**：数据库中留下 `end_time = NULL` 或 `completed_at = NULL` 的记录

3. **无法启动新会话**：后端检测到活跃的细分时间段，拒绝创建新的时间段

### 后端验证逻辑

```typescript
// focus-period.controller.ts:22-28
const activePeriod = await this.focusPeriodRepository.getActivePeriod(Number(sessionId));
if (activePeriod) {
  res.status(400).json({
    message: '当前会话已有活跃的细分时间段，请先结束当前时间段'
  });
  return;
}
```

---

## 🛡️ 防止问题的最佳实践

### 1. 正常退出流程

始终使用应用内的退出按钮，而不是直接关闭窗口：
- ✅ 点击"离开"按钮
- ✅ 点击"我做完了"按钮
- ✅ 点击"我搞错了"按钮
- ❌ 避免直接关闭浏览器标签页

### 2. 使用 npm scripts 启动

```bash
# 推荐
npm run dev    # ✅ 自动清理

# 不推荐
node dist/server.js  # ❌ 不会自动清理
ts-node src/server.ts  # ❌ 不会自动清理
```

### 3. 定期手动清理

如果经常遇到问题，建议：
- 每天开始工作前运行一次 `npm run cleanup`
- 每次异常关闭后运行一次清理脚本

---

## 📂 相关文件位置

| 文件 | 路径 | 说明 |
|------|------|------|
| 清理脚本（JS） | `Arzu_simulator_back/scripts/cleanup-active-sessions.js` | Node.js清理脚本 |
| 清理脚本（批处理） | `Arzu_simulator_back/清理会话.bat` | Windows快捷方式 |
| 旧清理脚本 | `Arzu_simulator_back/清理活跃会话.js` | 已废弃（使用旧数据库路径） |
| package.json | `Arzu_simulator_back/package.json` | npm scripts配置 |

---

## 🔧 技术细节

### npm scripts 配置

```json
{
  "scripts": {
    "cleanup": "node scripts/cleanup-active-sessions.js",
    "predev": "npm run cleanup",  // 开发模式启动前自动清理
    "dev": "ts-node-dev --respawn --transpile-only src/server.ts",
    "prestart": "npm run cleanup",  // 生产模式启动前自动清理
    "start": "node dist/server.js"
  }
}
```

### 数据库查询

```sql
-- 查找未结束的细分时间段
SELECT * FROM focus_periods WHERE end_time IS NULL;

-- 查找未结束的番茄钟会话
SELECT * FROM pomodoro_sessions WHERE completed_at IS NULL;

-- 手动清理（不推荐）
UPDATE focus_periods 
SET end_time = datetime('now'), 
    is_interrupted = 1 
WHERE end_time IS NULL;

UPDATE pomodoro_sessions 
SET completed_at = datetime('now'), 
    completed = 0 
WHERE completed_at IS NULL;
```

---

## ❓ 常见问题

### Q1: 清理脚本会删除我的数据吗？

**A**: ❌ 不会！清理脚本只会：
- 结束未结束的会话（设置结束时间）
- 保留所有历史记录
- 不会删除任何任务、日志或统计数据

### Q2: 为什么我的旧清理脚本（清理活跃会话.js）不工作了？

**A**: 旧脚本使用了错误的数据库路径：
```javascript
// 旧脚本（错误）
const db = new sqlite3.Database('./database_new_2025-09-25T08-54-04-778Z.db');

// 新脚本（正确）
const db = new sqlite3.Database('./database.db');
```

### Q3: 我可以禁用自动清理吗？

**A**: 可以，但不推荐。如果确实需要：

```json
// package.json - 删除以下两行
"predev": "npm run cleanup",
"prestart": "npm run cleanup",
```

### Q4: 清理脚本执行失败怎么办？

**A**: 检查以下几点：
1. 确保数据库文件 `database.db` 存在
2. 确保数据库文件没有被其他进程占用
3. 确保有读写权限
4. 查看详细错误信息

---

## 📝 更新日志

### v1.1.0 (2025-10-25)
- ✅ 创建自动化清理脚本 `scripts/cleanup-active-sessions.js`
- ✅ 集成到 npm scripts (`predev`, `prestart`)
- ✅ 添加 Windows 批处理文件 `清理会话.bat`
- ✅ 修复数据库路径问题（使用 `database.db` 而非旧数据库）
- ✅ 添加详细日志输出

### v1.0.0 (2025-09-25)
- ✅ 初始清理脚本 `清理活跃会话.js`（已废弃）

---

## 🎯 总结

1. **使用 `npm run dev` 启动后端** → 自动清理 ✅
2. **遇到问题时运行 `npm run cleanup`** → 手动清理 ✅
3. **正常退出应用** → 避免数据残留 ✅

现在启动项目，系统会自动处理所有会话清理工作！🎉
